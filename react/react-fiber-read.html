<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>亿个本子</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="apple-touch-icon" sizes="180x180" href="/archived/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" href="/archived/favicon/favicon-16x16.png">
    <link rel="icon" type="image/png" href="/archived/favicon/favicon-32x32.png">
    <link rel="manifest" href="/archived/favicon/site.webmanifest">
    <meta name="description" content="frontend related notes">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="preload" href="/archived/assets/css/0.styles.44ae0491.css" as="style"><link rel="preload" href="/archived/assets/js/app.8b58d644.js" as="script"><link rel="preload" href="/archived/assets/js/2.bf33e473.js" as="script"><link rel="preload" href="/archived/assets/js/42.c40fcb14.js" as="script"><link rel="prefetch" href="/archived/assets/js/10.08eb2b05.js"><link rel="prefetch" href="/archived/assets/js/11.8af729f7.js"><link rel="prefetch" href="/archived/assets/js/12.89a362e4.js"><link rel="prefetch" href="/archived/assets/js/13.333ebb92.js"><link rel="prefetch" href="/archived/assets/js/14.fecca8fb.js"><link rel="prefetch" href="/archived/assets/js/15.d74cca93.js"><link rel="prefetch" href="/archived/assets/js/16.33b6a90d.js"><link rel="prefetch" href="/archived/assets/js/17.a8d0bc73.js"><link rel="prefetch" href="/archived/assets/js/18.99e676ac.js"><link rel="prefetch" href="/archived/assets/js/19.8f4f6bc7.js"><link rel="prefetch" href="/archived/assets/js/20.b60b2514.js"><link rel="prefetch" href="/archived/assets/js/21.1409a82a.js"><link rel="prefetch" href="/archived/assets/js/22.0f7af644.js"><link rel="prefetch" href="/archived/assets/js/23.24d2717c.js"><link rel="prefetch" href="/archived/assets/js/24.1f557f08.js"><link rel="prefetch" href="/archived/assets/js/25.6d9fa012.js"><link rel="prefetch" href="/archived/assets/js/26.0c4a868e.js"><link rel="prefetch" href="/archived/assets/js/27.4452b985.js"><link rel="prefetch" href="/archived/assets/js/28.f467e649.js"><link rel="prefetch" href="/archived/assets/js/29.13e49743.js"><link rel="prefetch" href="/archived/assets/js/3.9903a5d7.js"><link rel="prefetch" href="/archived/assets/js/30.f8890062.js"><link rel="prefetch" href="/archived/assets/js/31.22830e2f.js"><link rel="prefetch" href="/archived/assets/js/32.9945a466.js"><link rel="prefetch" href="/archived/assets/js/33.8354ffb2.js"><link rel="prefetch" href="/archived/assets/js/34.b80b6b78.js"><link rel="prefetch" href="/archived/assets/js/35.b5435a07.js"><link rel="prefetch" href="/archived/assets/js/36.6eb06aac.js"><link rel="prefetch" href="/archived/assets/js/37.78e82f4a.js"><link rel="prefetch" href="/archived/assets/js/38.bae8bf11.js"><link rel="prefetch" href="/archived/assets/js/39.61fc07c0.js"><link rel="prefetch" href="/archived/assets/js/4.45587ab2.js"><link rel="prefetch" href="/archived/assets/js/40.4ff96977.js"><link rel="prefetch" href="/archived/assets/js/41.24669c96.js"><link rel="prefetch" href="/archived/assets/js/43.77267e49.js"><link rel="prefetch" href="/archived/assets/js/44.684a4efa.js"><link rel="prefetch" href="/archived/assets/js/45.ec35426d.js"><link rel="prefetch" href="/archived/assets/js/46.9af30f73.js"><link rel="prefetch" href="/archived/assets/js/5.7048f9e2.js"><link rel="prefetch" href="/archived/assets/js/6.51e4d4fc.js"><link rel="prefetch" href="/archived/assets/js/7.43067d64.js"><link rel="prefetch" href="/archived/assets/js/8.09d20108.js"><link rel="prefetch" href="/archived/assets/js/9.c803c07c.js">
    <link rel="stylesheet" href="/archived/assets/css/0.styles.44ae0491.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/archived/" class="home-link router-link-active"><img src="/archived/favicon/favicon-32x32.png" alt="亿个本子" class="logo"> <span class="site-name can-hide">亿个本子</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/wmtdhe" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://github.com/wmtdhe" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>React</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/archived/react/react-fiber-read.html" aria-current="page" class="active sidebar-link">setState批量更新源码阅读</a></li><li><a href="/archived/react/tree-diffing.html" class="sidebar-link">协调之Tree Diffing算法</a></li><li><a href="/archived/react/controlled-and-uncontrolled-components.html" class="sidebar-link">受控和非受控组件</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Algorithm</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Webpack</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Networks</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CSS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Operation System</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Micellaneous</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Practice</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>版本：<code>React 16.13.1</code></p> <p><code>React</code>批量更新原则：</p> <p>同一事件中如果有多个更新，尽管他们的<code>event time</code>可能不同，但是都会被同一时间更新</p> <p><code>fiber</code>之前的<code>React</code>更新是从上到下遍历更新的，如果一个组件过于复杂，组成部分很多，则更新一次这个组件可能会花较长的时间，如更新这个组件花费了1s，在这1s内，主线程完全被<code>React</code>更新霸占，导致别的交互、渲染什么的出现了卡顿等不流畅现象。</p> <p><code>fiber</code>的出现对时间进行了<strong>分片</strong> —— 1s有60帧，1帧为16.66ms，如果在1帧中执行了别的<strong>渲染</strong>和<strong>用户输入响应</strong>之后还有剩余时间，<code>React</code>则会利用剩余时间对组件进行更新。因为<code>fiber</code>，<code>React</code>的更新可以暂停，恢复以及根据<code>priority 优先级</code>交出当前更新执行权到更高的优先级的更新上。从而使得<code>React</code>不长时间霸占主线程，优化性能。</p> <p><code>requestHostCallback</code>安排一个<code>host的回调</code>，通过<code>postMessage</code></p> <p><code>fiber</code>维护了两个<code>state tree</code>，一个是<strong>上次更新的</strong>，一个是<strong>正在进行变更的</strong>，从而使得两个可以互换，舍弃，继续更新。</p> <h4 id="packages-react-reconciler-src-reactfiberclasscomponent-new-js"><a href="#packages-react-reconciler-src-reactfiberclasscomponent-new-js" class="header-anchor">#</a> packages/react-reconciler/src/ReactFiberClassComponent.new.js</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> classComponentUpdater <span class="token operator">=</span> <span class="token punctuation">{</span>
  isMounted<span class="token punctuation">,</span>
  <span class="token function">enqueueSetState</span><span class="token punctuation">(</span><span class="token parameter">inst<span class="token punctuation">,</span> payload<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 把 setState 排入队列</span>
    <span class="token keyword">const</span> fiber <span class="token operator">=</span> <span class="token function">getInstance</span><span class="token punctuation">(</span>inst<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> eventTime <span class="token operator">=</span> <span class="token function">requestEventTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> suspenseConfig <span class="token operator">=</span> <span class="token function">requestCurrentSuspenseConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> lane <span class="token operator">=</span> <span class="token function">requestUpdateLane</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> suspenseConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// update object有eventTime，lane，suspenseConfig，payload，callback</span>
    <span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token function">createUpdate</span><span class="token punctuation">(</span>eventTime<span class="token punctuation">,</span> lane<span class="token punctuation">,</span> suspenseConfig<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回的是一个update object</span>
    update<span class="token punctuation">.</span>payload <span class="token operator">=</span> payload<span class="token punctuation">;</span> <span class="token comment">// 添加更新的 data payload</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> callback <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 添加更新后的回调函数</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warnOnInvalidCallback</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> <span class="token string">'setState'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      update<span class="token punctuation">.</span>callback <span class="token operator">=</span> callback<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">enqueueUpdate</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 将update添加到fiber的updateQueue中</span>
    <span class="token function">scheduleUpdateOnFiber</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> lane<span class="token punctuation">,</span> eventTime<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调度fiber上的update</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">enqueueReplaceState</span><span class="token punctuation">(</span><span class="token parameter">inst<span class="token punctuation">,</span> payload<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> fiber <span class="token operator">=</span> <span class="token function">getInstance</span><span class="token punctuation">(</span>inst<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> eventTime <span class="token operator">=</span> <span class="token function">requestEventTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> suspenseConfig <span class="token operator">=</span> <span class="token function">requestCurrentSuspenseConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> lane <span class="token operator">=</span> <span class="token function">requestUpdateLane</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> suspenseConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token function">createUpdate</span><span class="token punctuation">(</span>eventTime<span class="token punctuation">,</span> lane<span class="token punctuation">,</span> suspenseConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
    update<span class="token punctuation">.</span>tag <span class="token operator">=</span> ReplaceState<span class="token punctuation">;</span>
    update<span class="token punctuation">.</span>payload <span class="token operator">=</span> payload<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> callback <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warnOnInvalidCallback</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> <span class="token string">'replaceState'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      update<span class="token punctuation">.</span>callback <span class="token operator">=</span> callback<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">enqueueUpdate</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">scheduleUpdateOnFiber</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> lane<span class="token punctuation">,</span> eventTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">enqueueForceUpdate</span><span class="token punctuation">(</span><span class="token parameter">inst<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> fiber <span class="token operator">=</span> <span class="token function">getInstance</span><span class="token punctuation">(</span>inst<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> eventTime <span class="token operator">=</span> <span class="token function">requestEventTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> suspenseConfig <span class="token operator">=</span> <span class="token function">requestCurrentSuspenseConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> lane <span class="token operator">=</span> <span class="token function">requestUpdateLane</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> suspenseConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token function">createUpdate</span><span class="token punctuation">(</span>eventTime<span class="token punctuation">,</span> lane<span class="token punctuation">,</span> suspenseConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
    update<span class="token punctuation">.</span>tag <span class="token operator">=</span> ForceUpdate<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> callback <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warnOnInvalidCallback</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> <span class="token string">'forceUpdate'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      update<span class="token punctuation">.</span>callback <span class="token operator">=</span> callback<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">enqueueUpdate</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">scheduleUpdateOnFiber</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> lane<span class="token punctuation">,</span> eventTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


</code></pre></div><h4 id="reactqueueupdate-new-js"><a href="#reactqueueupdate-new-js" class="header-anchor">#</a> ReactQueueUpdate.new.js</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> enqueueUpdate<span class="token operator">&lt;</span>State<span class="token operator">&gt;</span><span class="token punctuation">(</span>fiber<span class="token operator">:</span> Fiber<span class="token punctuation">,</span> update<span class="token operator">:</span> Update<span class="token operator">&lt;</span>State<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> updateQueue <span class="token operator">=</span> fiber<span class="token punctuation">.</span>updateQueue<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>updateQueue <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Only occurs if the fiber has been unmounted.</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> sharedQueue<span class="token operator">:</span> SharedQueue<span class="token operator">&lt;</span>State<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">(</span>updateQueue<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>shared<span class="token punctuation">;</span>
  <span class="token keyword">const</span> pending <span class="token operator">=</span> sharedQueue<span class="token punctuation">.</span>pending<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>pending <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// This is the first update. Create a circular list.</span>
    update<span class="token punctuation">.</span>next <span class="token operator">=</span> update<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    update<span class="token punctuation">.</span>next <span class="token operator">=</span> pending<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
    pending<span class="token punctuation">.</span>next <span class="token operator">=</span> update<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  sharedQueue<span class="token punctuation">.</span>pending <span class="token operator">=</span> update<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      currentlyProcessingQueue <span class="token operator">===</span> sharedQueue <span class="token operator">&amp;&amp;</span>
      <span class="token operator">!</span>didWarnUpdateInsideUpdate
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>
        <span class="token string">'An update (setState, replaceState, or forceUpdate) was scheduled '</span> <span class="token operator">+</span>
          <span class="token string">'from inside an update function. Update functions should be pure, '</span> <span class="token operator">+</span>
          <span class="token string">'with zero side-effects. Consider using componentDidUpdate or a '</span> <span class="token operator">+</span>
          <span class="token string">'callback.'</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      didWarnUpdateInsideUpdate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h4 id="packages-react-reconciler-src-reactfiberworkloop-new-js"><a href="#packages-react-reconciler-src-reactfiberworkloop-new-js" class="header-anchor">#</a> packages/react-reconciler/src/ReactFiberWorkLoop.new.js</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">scheduleUpdateOnFiber</span><span class="token punctuation">(</span>
  <span class="token parameter">fiber<span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  lane<span class="token operator">:</span> Lane<span class="token punctuation">,</span>
  eventTime<span class="token operator">:</span> number<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">checkForNestedUpdates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">warnAboutRenderPhaseUpdatesInDEV</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token function">markUpdateLaneFromFiberToRoot</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> lane<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">warnAboutUpdateOnUnmountedFiberInDEV</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// TODO: requestUpdateLanePriority also reads the priority. Pass the</span>
  <span class="token comment">// priority as an argument to that function and this one.</span>
  <span class="token keyword">const</span> priorityLevel <span class="token operator">=</span> <span class="token function">getCurrentPriorityLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>lane <span class="token operator">===</span> SyncLane<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 同步更新</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      <span class="token comment">// Check if we're inside unbatchedUpdates 如果是非批量更新上下文</span>
      <span class="token punctuation">(</span>executionContext <span class="token operator">&amp;</span> LegacyUnbatchedContext<span class="token punctuation">)</span> <span class="token operator">!==</span> NoContext <span class="token operator">&amp;&amp;</span>
      <span class="token comment">// Check if we're not already rendering 如果不是在渲染或提交上下文</span>
      <span class="token punctuation">(</span>executionContext <span class="token operator">&amp;</span> <span class="token punctuation">(</span>RenderContext <span class="token operator">|</span> CommitContext<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">===</span> NoContext
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Register pending interactions on the root to avoid losing traced interaction data.</span>
      <span class="token function">schedulePendingInteractions</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lane<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// This is a legacy edge case. The initial mount of a ReactDOM.render-ed</span>
      <span class="token comment">// root inside of batchedUpdates should be synchronous, but layout updates</span>
      <span class="token comment">// should be deferred until the end of the batch.</span>
      <span class="token function">performSyncWorkOnRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">ensureRootIsScheduled</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> eventTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">schedulePendingInteractions</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lane<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>executionContext <span class="token operator">===</span> NoContext<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token comment">// Flush the synchronous work now, unless we're already working or inside</span>
        <span class="token comment">// a batch. This is intentionally inside scheduleUpdateOnFiber instead of</span>
        <span class="token comment">// scheduleCallbackForFiber to preserve the ability to schedule a callback</span>
        <span class="token comment">// without immediately flushing it. We only do this for user-initiated</span>
        <span class="token comment">// updates, to preserve historical behavior of legacy mode.</span>
        <span class="token function">flushSyncCallbackQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// Schedule a discrete update but only if it's not Sync.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token comment">// 独立事件上下文并且优先级为ImmediateScheduler或者UserBlockingScheduler</span>
      <span class="token punctuation">(</span>executionContext <span class="token operator">&amp;</span> DiscreteEventContext<span class="token punctuation">)</span> <span class="token operator">!==</span> NoContext <span class="token operator">&amp;&amp;</span> 
      <span class="token comment">// Only updates at user-blocking priority or greater are considered</span>
      <span class="token comment">// discrete, even inside a discrete event.</span>
      <span class="token punctuation">(</span>priorityLevel <span class="token operator">===</span> UserBlockingSchedulerPriority <span class="token operator">||</span>
        priorityLevel <span class="token operator">===</span> ImmediateSchedulerPriority<span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// This is the result of a discrete event. Track the lowest priority</span>
      <span class="token comment">// discrete update per root so we can flush them early, if needed.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>rootsWithPendingDiscreteUpdates <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        rootsWithPendingDiscreteUpdates <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span>root<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        rootsWithPendingDiscreteUpdates<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Schedule other updates after in case the callback is sync. 其他上下文的更新，如批量更新上下文 batchedContext</span>
    <span class="token function">ensureRootIsScheduled</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> eventTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">schedulePendingInteractions</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lane<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// We use this when assigning a lane for a transition inside</span>
  <span class="token comment">// `requestUpdateLane`. We assume it's the same as the root being updated,</span>
  <span class="token comment">// since in the common case of a single root app it probably is. If it's not</span>
  <span class="token comment">// the same root, then it's not a huge deal, we just might batch more stuff</span>
  <span class="token comment">// together more than necessary.</span>
  mostRecentlyUpdatedRoot <span class="token operator">=</span> root<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="fiber"><a href="#fiber" class="header-anchor">#</a> fiber</h4> <blockquote><p>A Fiber is work on a Component that needs to be done or was done. There can
be more than one per component.</p> <p>fiber是组件上需要做的或者已经完成的工作，一个组件可能有多个fiber</p> <p>任务有优先级，高优先级会打断正在进行的低优先级任务</p></blockquote> <p><strong>Fiber数据结构</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">export</span> type Fiber <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">|</span>
  <span class="token comment">// These first fields are conceptually members of an Instance. This used to</span>
  <span class="token comment">// be split into a separate type and intersected with the other Fiber fields,</span>
  <span class="token comment">// but until Flow fixes its intersection bugs, we've merged them into a</span>
  <span class="token comment">// single type.</span>

  <span class="token comment">// An Instance is shared between all versions of a component. We can easily</span>
  <span class="token comment">// break this out into a separate object to avoid copying so much to the</span>
  <span class="token comment">// alternate versions of the tree. We put this on a single object for now to</span>
  <span class="token comment">// minimize the number of objects created during the initial render.</span>

  <span class="token comment">// Tag identifying the type of fiber.</span>
  tag<span class="token operator">:</span> WorkTag<span class="token punctuation">,</span>

  <span class="token comment">// Unique identifier of this child.</span>
  key<span class="token operator">:</span> <span class="token keyword">null</span> <span class="token operator">|</span> string<span class="token punctuation">,</span>

  <span class="token comment">// The value of element.type which is used to preserve the identity during</span>
  <span class="token comment">// reconciliation of this child.</span>
  elementType<span class="token operator">:</span> any<span class="token punctuation">,</span>

  <span class="token comment">// The resolved function/class/ associated with this fiber.</span>
  type<span class="token operator">:</span> any<span class="token punctuation">,</span>

  <span class="token comment">// The local state associated with this fiber. 通常指的DOM元素</span>
  <span class="token comment">/** ！！！批量更新之前恢复的状态来源！！！ **/</span>
  stateNode<span class="token operator">:</span> any<span class="token punctuation">,</span>

  <span class="token comment">// Conceptual aliases</span>
  <span class="token comment">// parent : Instance -&gt; return The parent happens to be the same as the</span>
  <span class="token comment">// return fiber since we've merged the fiber and instance.</span>

  <span class="token comment">// Remaining fields belong to Fiber</span>

  <span class="token comment">// The Fiber to return to after finishing processing this one.</span>
  <span class="token comment">// This is effectively the parent, but there can be multiple parents (two)</span>
  <span class="token comment">// so this is only the parent of the thing we're currently processing.</span>
  <span class="token comment">// It is conceptually the same as the return address of a stack frame.</span>
  <span class="token keyword">return</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>

  <span class="token comment">// Singly Linked List Tree Structure. 单链表</span>
  child<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  sibling<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  index<span class="token operator">:</span> number<span class="token punctuation">,</span>

  <span class="token comment">// The ref last used to attach this node.</span>
  <span class="token comment">// I'll avoid adding an owner field for prod and model that as functions.</span>
  ref<span class="token operator">:</span>
    <span class="token operator">|</span> <span class="token keyword">null</span>
    <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">handle<span class="token operator">:</span> mixed</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">{</span>_stringRef<span class="token operator">:</span> <span class="token operator">?</span>string<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token operator">|</span> RefObject<span class="token punctuation">,</span>

  <span class="token comment">// Input is the data coming into process this fiber. Arguments. Props.</span>
  pendingProps<span class="token operator">:</span> any<span class="token punctuation">,</span> <span class="token comment">// This type will be more specific once we overload the tag. 还未更新的props</span>
  memoizedProps<span class="token operator">:</span> any<span class="token punctuation">,</span> <span class="token comment">// The props used to create the output. 之前的props</span>

  <span class="token comment">// A queue of state updates and callbacks. 状态更新和回调的队列</span>
  updateQueue<span class="token operator">:</span> mixed<span class="token punctuation">,</span>

  <span class="token comment">// The state used to create the output 之前的状态</span>
  memoizedState<span class="token operator">:</span> any<span class="token punctuation">,</span>

  <span class="token comment">// Dependencies (contexts, events) for this fiber, if it has any</span>
  dependencies<span class="token operator">:</span> Dependencies <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>

  <span class="token comment">// Bitfield that describes properties about the fiber and its subtree. E.g.</span>
  <span class="token comment">// the ConcurrentMode flag indicates whether the subtree should be async-by-</span>
  <span class="token comment">// default. When a fiber is created, it inherits the mode of its</span>
  <span class="token comment">// parent. Additional flags can be set at creation time, but after that the</span>
  <span class="token comment">// value should remain unchanged throughout the fiber's lifetime, particularly</span>
  <span class="token comment">// before its child fibers are created.</span>
  mode<span class="token operator">:</span> TypeOfMode<span class="token punctuation">,</span>

  <span class="token comment">// Effect</span>
  effectTag<span class="token operator">:</span> SideEffectTag<span class="token punctuation">,</span>

  <span class="token comment">// Singly linked list fast path to the next fiber with side-effects.</span>
  <span class="token comment">// 单链，连接下一个有副作用的fiber（需要进行DOM操作的节点）</span>
  nextEffect<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>

  <span class="token comment">// The first and last fiber with side-effect within this subtree. This allows</span>
  <span class="token comment">// us to reuse a slice of the linked list when we reuse the work done within</span>
  <span class="token comment">// this fiber.</span>
  firstEffect<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  lastEffect<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>

  lanes<span class="token operator">:</span> Lanes<span class="token punctuation">,</span>
  childLanes<span class="token operator">:</span> Lanes<span class="token punctuation">,</span>

  <span class="token comment">// This is a pooled version of a Fiber. Every fiber that gets updated will</span>
  <span class="token comment">// eventually have a pair. There are cases when we can clean up pairs to save</span>
  <span class="token comment">// memory if we need to.</span>
  <span class="token comment">// 每个会更新的fiber都有一个相应的pair</span>
  alternate<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>

  <span class="token comment">// Time spent rendering this Fiber and its descendants for the current update.</span>
  <span class="token comment">// This tells us how well the tree makes use of sCU for memoization.</span>
  <span class="token comment">// It is reset to 0 each time we render and only updated when we don't bailout.</span>
  <span class="token comment">// This field is only set when the enableProfilerTimer flag is enabled.</span>
  actualDuration<span class="token operator">?</span><span class="token operator">:</span> number<span class="token punctuation">,</span>

  <span class="token comment">// If the Fiber is currently active in the &quot;render&quot; phase,</span>
  <span class="token comment">// This marks the time at which the work began.</span>
  <span class="token comment">// This field is only set when the enableProfilerTimer flag is enabled.</span>
  actualStartTime<span class="token operator">?</span><span class="token operator">:</span> number<span class="token punctuation">,</span>

  <span class="token comment">// Duration of the most recent render time for this Fiber.</span>
  <span class="token comment">// This value is not updated when we bailout for memoization purposes.</span>
  <span class="token comment">// This field is only set when the enableProfilerTimer flag is enabled.</span>
  selfBaseDuration<span class="token operator">?</span><span class="token operator">:</span> number<span class="token punctuation">,</span>

  <span class="token comment">// Sum of base times for all descendants of this Fiber.</span>
  <span class="token comment">// This value bubbles up during the &quot;complete&quot; phase.</span>
  <span class="token comment">// This field is only set when the enableProfilerTimer flag is enabled.</span>
  treeBaseDuration<span class="token operator">?</span><span class="token operator">:</span> number<span class="token punctuation">,</span>

  <span class="token comment">// Conceptual aliases</span>
  <span class="token comment">// workInProgress : Fiber -&gt;  alternate The alternate used for reuse happens</span>
  <span class="token comment">// to be the same as work in progress.</span>
  <span class="token comment">// __DEV__ only</span>
  _debugID<span class="token operator">?</span><span class="token operator">:</span> number<span class="token punctuation">,</span>
  _debugSource<span class="token operator">?</span><span class="token operator">:</span> Source <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  _debugOwner<span class="token operator">?</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  _debugIsCurrentlyTiming<span class="token operator">?</span><span class="token operator">:</span> boolean<span class="token punctuation">,</span>
  _debugNeedsRemount<span class="token operator">?</span><span class="token operator">:</span> boolean<span class="token punctuation">,</span>

  <span class="token comment">// Used to verify that the order of hooks does not change between renders.</span>
  _debugHookTypes<span class="token operator">?</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>HookType<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
<span class="token operator">|</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>React对于事件的处理有6种优先级</p> <ol><li>ImmediatePriority</li> <li>UserBlockingPriority</li> <li>NormalPriority</li> <li>LowPriority</li> <li>IdlePriority -&gt; 当浏览器空闲时才执行</li> <li>NoPriority (当没有指明以上priority时的priority)</li></ol> <p>// scheduler/src/Scheduler.js 各个优先级过期时间 -&gt; 过期时则立马执行</p> <p><code>expirationTime = eventTime + timeout</code></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> maxSigned31BitInt <span class="token operator">=</span> <span class="token number">1073741823</span><span class="token punctuation">;</span>
<span class="token comment">// Times out immediately</span>
<span class="token keyword">var</span> <span class="token constant">IMMEDIATE_PRIORITY_TIMEOUT</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">// Eventually times out</span>
<span class="token keyword">var</span> <span class="token constant">USER_BLOCKING_PRIORITY_TIMEOUT</span> <span class="token operator">=</span> <span class="token number">250</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> <span class="token constant">NORMAL_PRIORITY_TIMEOUT</span> <span class="token operator">=</span> <span class="token number">5000</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> <span class="token constant">LOW_PRIORITY_TIMEOUT</span> <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span>
<span class="token comment">// Never times out</span>
<span class="token keyword">var</span> <span class="token constant">IDLE_PRIORITY_TIMEOUT</span> <span class="token operator">=</span> maxSigned31BitInt<span class="token punctuation">;</span>
</code></pre></div><p>// packages/scheduler/src/SchedulerMinHeap.js</p> <p>任务nodes通过最小堆来存储，优先级越高越靠前</p> <h3 id="batchedeventupdates-batchedupdates"><a href="#batchedeventupdates-batchedupdates" class="header-anchor">#</a> batchedEventUpdates, batchedUpdates</h3> <ul><li>packages/react-reconciler/src/ReactFiberReconciler.js</li> <li>packages/react-reconciler/src/ReactFiberWorkLoop.new.js and ReactFiberWorkLoop.old.js</li> <li>packages/react-dom/index.js</li> <li>packages/react-dom/src/client/ReactDOM.js</li></ul> <p><strong>ReactFiberReconciler中的batchedUpdates</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// from ReactFiberReconciler</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> batchedUpdates<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token punctuation">,</span> <span class="token constant">R</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token function-variable function">fn</span><span class="token operator">:</span> <span class="token parameter"><span class="token constant">A</span></span> <span class="token operator">=&gt;</span> <span class="token constant">R</span><span class="token punctuation">,</span> a<span class="token operator">:</span> <span class="token constant">A</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">R</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> prevExecutionContext <span class="token operator">=</span> executionContext<span class="token punctuation">;</span>
  executionContext <span class="token operator">|=</span> BatchedContext<span class="token punctuation">;</span> <span class="token comment">// 切换到批量更新上下文环境</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    executionContext <span class="token operator">=</span> prevExecutionContext<span class="token punctuation">;</span> <span class="token comment">// 更新成功与否都回到之前都上下文环境</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>executionContext <span class="token operator">===</span> NoContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Flush the immediate callbacks that were scheduled during this batch</span>
      <span class="token function">flushSyncCallbackQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// inside packages/react-dom/src/events/ReactDOMUpdateBatching.js</span>

<span class="token comment">// Defaults 默认批量更新方法</span>
<span class="token keyword">let</span> <span class="token function-variable function">batchedUpdatesImpl</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> bookkeeping</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span>bookkeeping<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token function-variable function">discreteUpdatesImpl</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token function-variable function">flushDiscreteUpdatesImpl</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> batchedEventUpdatesImpl <span class="token operator">=</span> batchedUpdatesImpl<span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span>
<span class="token function">setBatchingImplementation</span><span class="token punctuation">(</span>
  <span class="token parameter">_batchedUpdatesImpl<span class="token punctuation">,</span>
  _discreteUpdatesImpl<span class="token punctuation">,</span>
  _flushDiscreteUpdatesImpl<span class="token punctuation">,</span>
  _batchedEventUpdatesImpl<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  batchedUpdatesImpl <span class="token operator">=</span> _batchedUpdatesImpl<span class="token punctuation">;</span>
  discreteUpdatesImpl <span class="token operator">=</span> _discreteUpdatesImpl<span class="token punctuation">;</span>
  flushDiscreteUpdatesImpl <span class="token operator">=</span> _flushDiscreteUpdatesImpl<span class="token punctuation">;</span>
  batchedEventUpdatesImpl <span class="token operator">=</span> _batchedEventUpdatesImpl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// inside react-dom/src/client/ReactDOM.js</span>

<span class="token comment">// 将react-reconciler/ReactFiberReconciler中的批量更新方法添加到ReactDOM.js中</span>
<span class="token function">setBatchingImplementation</span><span class="token punctuation">(</span>
  batchedUpdates<span class="token punctuation">,</span>
  discreteUpdates<span class="token punctuation">,</span>
  flushDiscreteUpdates<span class="token punctuation">,</span>
  batchedEventUpdates<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 也向外通过unstable_batchedUpdates暴露了批量更新的方法</span>
<span class="token comment">// ReactDOM.unstable_batchedUpdates(fn)</span>
</code></pre></div><p><strong>react-dom/src/events/ReactDOMUpdateBatching.js</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 如果是在事件处理回调中的话，需要进行批量更新</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">batchedUpdates</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> bookkeeping</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isInsideEventHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// If we are currently inside another batch, we need to wait until it</span>
    <span class="token comment">// fully completes before restoring state.</span>
    <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span>bookkeeping<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  isInsideEventHandler <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">batchedUpdatesImpl</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> bookkeeping<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    isInsideEventHandler <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token function">finishEventHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 如果是别的批量更新中的批量更新的话，需要等待外层的更新完再批量更新</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">batchedEventUpdates</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isBatchingEventUpdates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// If we are currently inside another batch, we need to wait until it</span>
    <span class="token comment">// fully completes before restoring state.</span>
    <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  isBatchingEventUpdates <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">batchedEventUpdatesImpl</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    isBatchingEventUpdates <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token function">finishEventHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">finishEventHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Here we wait until all updates have propagated, which is important</span>
  <span class="token comment">// when using controlled components within layers:</span>
  <span class="token comment">// https://github.com/facebook/react/issues/1698</span>
  <span class="token comment">// Then we restore state of any controlled component.</span>
  <span class="token keyword">const</span> controlledComponentsHavePendingUpdates <span class="token operator">=</span> <span class="token function">needsStateRestore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token comment">// 当还有setState时，需要保持state不变，不更新到DOM上</span>
  
  <span class="token keyword">if</span> <span class="token punctuation">(</span>controlledComponentsHavePendingUpdates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// If a controlled event was fired, we may need to restore the state of</span>
    <span class="token comment">// the DOM node back to the controlled value. This is necessary when React</span>
    <span class="token comment">// bails out of the update without touching the DOM.</span>
    <span class="token function">flushDiscreteUpdatesImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 如果有需要单独更新的则执行</span>
    <span class="token function">restoreStateIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 恢复未更新时的状态</span>
    <span class="token comment">// 获取每个target的fiber instance</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="react-src-reactbaseclasses-js"><a href="#react-src-reactbaseclasses-js" class="header-anchor">#</a> react/src/ReactBaseClasses.js</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token class-name">Component</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">setState</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">partialState<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">invariant</span><span class="token punctuation">(</span>
    <span class="token keyword">typeof</span> partialState <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">||</span>
      <span class="token keyword">typeof</span> partialState <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">||</span>
      partialState <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token string">'setState(...): takes an object of state variables to update or a '</span> <span class="token operator">+</span>
      <span class="token string">'function which returns an object of state variables.'</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>updater<span class="token punctuation">.</span><span class="token function">enqueueSetState</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> partialState<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> <span class="token string">'setState'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="react-reconciler-src-reactfiberclasscomponent-js"><a href="#react-reconciler-src-reactfiberclasscomponent-js" class="header-anchor">#</a> react-reconciler/src/ReactFiberClassComponent.js</h4> <p>提供了基本的<code>fiber component updater</code></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> classComponentUpdater <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token comment">// 将setState加入更新队列</span>
    <span class="token function">enqueueSetState</span><span class="token punctuation">(</span><span class="token parameter">inst<span class="token punctuation">,</span> payload<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">const</span> fiber <span class="token operator">=</span> <span class="token function">getInstance</span><span class="token punctuation">(</span>inst<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> eventTime <span class="token operator">=</span> <span class="token function">requestEventTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> suspenseConfig <span class="token operator">=</span> <span class="token function">requestCurrentSuspenseConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> lane <span class="token operator">=</span> <span class="token function">requestUpdateLane</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> suspenseConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token function">createUpdate</span><span class="token punctuation">(</span>eventTime<span class="token punctuation">,</span> lane<span class="token punctuation">,</span> suspenseConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
    update<span class="token punctuation">.</span>payload <span class="token operator">=</span> payload<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> callback <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warnOnInvalidCallback</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> <span class="token string">'setState'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      update<span class="token punctuation">.</span>callback <span class="token operator">=</span> callback<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">enqueueUpdate</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将新的update添加到fiber的updateQueue上</span>
    <span class="token function">scheduleUpdateOnFiber</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> lane<span class="token punctuation">,</span> eventTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>enableDebugTracing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>mode <span class="token operator">&amp;</span> DebugTracingMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token function">getComponentName</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">'Unknown'</span><span class="token punctuation">;</span>
          <span class="token function">logStateUpdateScheduled</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> lane<span class="token punctuation">,</span> payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>enableSchedulingProfiler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">markStateUpdateScheduled</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> lane<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="react-reconciler-src-reactfiberbeginwork-new-js"><a href="#react-reconciler-src-reactfiberbeginwork-new-js" class="header-anchor">#</a> react-reconciler/src/ReactFiberBeginWork.new.js</h4> <p><code>beginWork()</code> 根据不同的<code>Component Type</code>创建了不同连接<code>fiber</code>的<code>Component instance</code>并对<code>fiber</code>上的<code>work</code>进行执行然后返回下一个单位的<code>work</code></p> <h4 id="react-reconciler-src-reactfiberworkloop-new-js"><a href="#react-reconciler-src-reactfiberworkloop-new-js" class="header-anchor">#</a> react-reconciler/src/ReactFiberWorkLoop.new.js</h4> <p>当<code>ReactComponent</code>调用<code>setState</code>方法时，都会先将<code>updates</code>放进对应<code>fiber</code>当<code>updateQueue</code>中，然后调用<code>scheduleUpdateOnFiber</code>对更新进行调度。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">scheduleUpdateOnFiber</span><span class="token punctuation">(</span>
  <span class="token parameter">fiber<span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  lane<span class="token operator">:</span> Lane<span class="token punctuation">,</span>
  eventTime<span class="token operator">:</span> number<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">checkForNestedUpdates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 检查是否有嵌套的更新 componentDidUpdate里有setState</span>
  <span class="token function">warnAboutRenderPhaseUpdatesInDEV</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 更新fiber上的lane，直到fiber root，将fiber root标记上有pending update</span>
  <span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token function">markUpdateLaneFromFiberToRoot</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> lane<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">warnAboutUpdateOnUnmountedFiberInDEV</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// TODO: requestUpdateLanePriority also reads the priority. Pass the</span>
  <span class="token comment">// priority as an argument to that function and this one.</span>
  <span class="token keyword">const</span> priorityLevel <span class="token operator">=</span> <span class="token function">getCurrentPriorityLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取当前优先级</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>lane <span class="token operator">===</span> SyncLane<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 同步</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      <span class="token comment">// 在非批量更新上下文或者非渲染和提交上下文的情况下</span>
      <span class="token comment">// Check if we're inside unbatchedUpdates</span>
      <span class="token punctuation">(</span>executionContext <span class="token operator">&amp;</span> LegacyUnbatchedContext<span class="token punctuation">)</span> <span class="token operator">!==</span> NoContext <span class="token operator">&amp;&amp;</span>
      <span class="token comment">// Check if we're not already rendering</span>
      <span class="token punctuation">(</span>executionContext <span class="token operator">&amp;</span> <span class="token punctuation">(</span>RenderContext <span class="token operator">|</span> CommitContext<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">===</span> NoContext
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Register pending interactions on the root to avoid losing traced interaction data.</span>
      <span class="token comment">// 在root上注册pending interactions避免丢失</span>
      <span class="token function">schedulePendingInteractions</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lane<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 最终触发scheduleInteractions(root, lane, __interactionsRef.current)</span>

      <span class="token comment">// This is a legacy edge case. The initial mount of a ReactDOM.render-ed</span>
      <span class="token comment">// root inside of batchedUpdates should be synchronous, but layout updates</span>
      <span class="token comment">// should be deferred until the end of the batch.</span>
      <span class="token comment">// 在root上执行同步任务</span>
      <span class="token function">performSyncWorkOnRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 在root上安排一个任务，每个root只有一个task，如果已经有任务被安排了，要保证已经存在的任务的expiration time和下一级root需要工作的task的expiration time一致</span>
      <span class="token function">ensureRootIsScheduled</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> eventTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">schedulePendingInteractions</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lane<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>executionContext <span class="token operator">===</span> NoContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Flush the synchronous work now, unless we're already working or inside</span>
        <span class="token comment">// a batch. This is intentionally inside scheduleUpdateOnFiber instead of</span>
        <span class="token comment">// scheduleCallbackForFiber to preserve the ability to schedule a callback</span>
        <span class="token comment">// without immediately flushing it. We only do this for user-initiated</span>
        <span class="token comment">// updates, to preserve historical behavior of legacy mode.</span>
        <span class="token function">flushSyncCallbackQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// Schedule a discrete update but only if it's not Sync.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      <span class="token punctuation">(</span>executionContext <span class="token operator">&amp;</span> DiscreteEventContext<span class="token punctuation">)</span> <span class="token operator">!==</span> NoContext <span class="token operator">&amp;&amp;</span>
      <span class="token comment">// Only updates at user-blocking priority or greater are considered</span>
      <span class="token comment">// discrete, even inside a discrete event.</span>
      <span class="token punctuation">(</span>priorityLevel <span class="token operator">===</span> UserBlockingSchedulerPriority <span class="token operator">||</span>
        priorityLevel <span class="token operator">===</span> ImmediateSchedulerPriority<span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// This is the result of a discrete event. Track the lowest priority</span>
      <span class="token comment">// discrete update per root so we can flush them early, if needed.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>rootsWithPendingDiscreteUpdates <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        rootsWithPendingDiscreteUpdates <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span>root<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        rootsWithPendingDiscreteUpdates<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Schedule other updates after in case the callback is sync.</span>
    <span class="token function">ensureRootIsScheduled</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> eventTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">schedulePendingInteractions</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lane<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// We use this when assigning a lane for a transition inside</span>
  <span class="token comment">// `requestUpdateLane`. We assume it's the same as the root being updated,</span>
  <span class="token comment">// since in the common case of a single root app it probably is. If it's not</span>
  <span class="token comment">// the same root, then it's not a huge deal, we just might batch more stuff</span>
  <span class="token comment">// together more than necessary.</span>
  mostRecentlyUpdatedRoot <span class="token operator">=</span> root<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><hr> <p><code>ensureRootIsScheduled 源码</code></p> <ul><li><code>ensureRootIsScheduled</code>保证了<code>root</code>上的<code>task</code>被调度安排好了，如果之前<code>root</code>上有<code>pending task</code>，会重新设定它的<code>expiration time</code>和下一级<code>task</code>的<code>expiration time</code>一样（延迟更新 batchedUpdates)。</li> <li>取消了<code>existingCallbackNode</code>上的<code>callback</code>，并安排新的<code>callback</code>。</li> <li><a href="https://github.com/facebook/react/blob/master/packages/react-reconciler/src/ReactFiberLane.js" target="_blank" rel="noopener noreferrer">ReactFiberLane源码<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <code>lanes</code>是一个二进制序列，当某条<code>lane</code>到了过期时限时，会通过<code>binary |</code>添加到<code>root.expirationLanes</code>上，
<ul><li><code>0b0000000000000000000000000000000</code> -&gt; <code>0b0000000000000000000000000000001</code>，index为0的lane标记为过期了</li></ul></li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// Use this function to schedule a task for a root. There's only one task per</span>
<span class="token comment">// root; if a task was already scheduled, we'll check to make sure the</span>
<span class="token comment">// expiration time of the existing task is the same as the expiration time of</span>
<span class="token comment">// the next level that the root has work on. This function is called on every</span>
<span class="token comment">// update, and right before exiting a task.</span>
<span class="token keyword">function</span> <span class="token function">ensureRootIsScheduled</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token operator">:</span> FiberRoot<span class="token punctuation">,</span> currentTime<span class="token operator">:</span> number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> existingCallbackNode <span class="token operator">=</span> root<span class="token punctuation">.</span>callbackNode<span class="token punctuation">;</span>

  <span class="token comment">// Check if any lanes are being starved by other work. If so, mark them as</span>
  <span class="token comment">// expired so we know to work on those next.</span>
  <span class="token comment">// 检查有没有已经过期的任务，有则加到root.expiredLanes上</span>
  <span class="token function">markStarvedLanesAsExpired</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Determine the next lanes to work on, and their priority.</span>
  <span class="token comment">// 判断接下来要执行的lane，任务和它们的优先级</span>
  <span class="token keyword">const</span> newCallbackId <span class="token operator">=</span> <span class="token function">getNextLanes</span><span class="token punctuation">(</span>
    root<span class="token punctuation">,</span>
    root <span class="token operator">===</span> workInProgressRoot <span class="token operator">?</span> workInProgressRootRenderLanes <span class="token operator">:</span> NoLanes<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// This returns the priority level computed during the `getNextLanes` call.</span>
  <span class="token comment">// 计算新任务的优先级</span>
  <span class="token keyword">const</span> newCallbackPriority <span class="token operator">=</span> <span class="token function">returnNextLanesPriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>newCallbackId <span class="token operator">===</span> NoLanes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Special case: There's nothing to work on.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>existingCallbackNode <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">cancelCallback</span><span class="token punctuation">(</span>existingCallbackNode<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      root<span class="token punctuation">.</span>callbackNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      root<span class="token punctuation">.</span>callbackPriority <span class="token operator">=</span> NoLanePriority<span class="token punctuation">;</span>
      root<span class="token punctuation">.</span>callbackId <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 检查有没有已存在的任务</span>
  <span class="token comment">// Check if there's an existing task. We may be able to reuse it.</span>
  <span class="token keyword">const</span> existingCallbackId <span class="token operator">=</span> root<span class="token punctuation">.</span>callbackId<span class="token punctuation">;</span>
  <span class="token keyword">const</span> existingCallbackPriority <span class="token operator">=</span> root<span class="token punctuation">.</span>callbackPriority<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>existingCallbackId <span class="token operator">!==</span> NoLanes<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 有existing task</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newCallbackId <span class="token operator">===</span> existingCallbackId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 新task已经被安排了</span>
      <span class="token comment">// This task is already scheduled. Let's check its priority.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>existingCallbackPriority <span class="token operator">===</span> newCallbackPriority<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// The priority hasn't changed. Exit.</span>
        <span class="token comment">// 检查优先级有没有变化，没有则退出</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// The task ID is the same but the priority changed. Cancel the existing</span>
      <span class="token comment">// callback. We'll schedule a new one below.</span>
      <span class="token comment">// 如果任务id没变但是优先级变了，先取消之前的回调</span>
      <span class="token comment">// 再安排一个新的</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 取消之前的task callback</span>
    <span class="token function">cancelCallback</span><span class="token punctuation">(</span>existingCallbackNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 安排新的 task callback</span>
  <span class="token comment">// Schedule a new callback.</span>
  <span class="token keyword">let</span> newCallbackNode<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>newCallbackPriority <span class="token operator">===</span> SyncLanePriority<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token comment">// 同步任务</span>
    <span class="token comment">// 被安排在一个特殊的内部队列里</span>
    <span class="token comment">// Special case: Sync React callbacks are scheduled on a special</span>
    <span class="token comment">// internal queue</span>
    newCallbackNode <span class="token operator">=</span> <span class="token function">scheduleSyncCallback</span><span class="token punctuation">(</span>
      <span class="token function">performSyncWorkOnRoot</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 普通异步任务，批量更新任务</span>
    <span class="token comment">// 获取新的调度优先级</span>
    <span class="token keyword">const</span> schedulerPriorityLevel <span class="token operator">=</span> <span class="token function">lanePriorityToSchedulerPriority</span><span class="token punctuation">(</span>
      newCallbackPriority<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 新的任务批量任务</span>
    newCallbackNode <span class="token operator">=</span> <span class="token function">scheduleCallback</span><span class="token punctuation">(</span>
      schedulerPriorityLevel<span class="token punctuation">,</span>
      <span class="token function">performConcurrentWorkOnRoot</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// callback为执行同时更新任务</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 给当前root安排新的callbackId，优先级和节点</span>
  root<span class="token punctuation">.</span>callbackId <span class="token operator">=</span> newCallbackId<span class="token punctuation">;</span>
  root<span class="token punctuation">.</span>callbackPriority <span class="token operator">=</span> newCallbackPriority<span class="token punctuation">;</span>
  root<span class="token punctuation">.</span>callbackNode <span class="token operator">=</span> newCallbackNode<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><hr> <p><code>scheduler/src/Scheduler</code></p> <ul><li><code>unstable_scheduleCallback</code>是<code>ensureRootIsScheduled</code>中的<code>scheduleCallback</code>，规划返回了新的任务。</li> <li><code>requestHostCallback</code>通过<code>postMessage</code>发起<code>performWorkUntilDeadline</code>，在deadline前执行更新操作，超过deadline将主线程控制交还给浏览器进行渲染和用户输入响应。</li> <li><code>flushWork</code>返回<code>workLoop</code></li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code> <span class="token keyword">function</span> <span class="token function">unstable_scheduleCallback</span><span class="token punctuation">(</span><span class="token parameter">priorityLevel<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> currentTime <span class="token operator">=</span> <span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> startTime<span class="token punctuation">;</span>
  <span class="token keyword">var</span> timeout<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> options <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> delay <span class="token operator">=</span> options<span class="token punctuation">.</span>delay<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> delay <span class="token operator">===</span> <span class="token string">'number'</span> <span class="token operator">&amp;&amp;</span> delay <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      startTime <span class="token operator">=</span> currentTime <span class="token operator">+</span> delay<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      startTime <span class="token operator">=</span> currentTime<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    timeout <span class="token operator">=</span>
      <span class="token keyword">typeof</span> options<span class="token punctuation">.</span>timeout <span class="token operator">===</span> <span class="token string">'number'</span>
        <span class="token operator">?</span> options<span class="token punctuation">.</span>timeout
        <span class="token operator">:</span> <span class="token function">timeoutForPriorityLevel</span><span class="token punctuation">(</span>priorityLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    timeout <span class="token operator">=</span> <span class="token function">timeoutForPriorityLevel</span><span class="token punctuation">(</span>priorityLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    startTime <span class="token operator">=</span> currentTime<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">var</span> expirationTime <span class="token operator">=</span> startTime <span class="token operator">+</span> timeout<span class="token punctuation">;</span>

  <span class="token keyword">var</span> newTask <span class="token operator">=</span> <span class="token punctuation">{</span>
    id<span class="token operator">:</span> taskIdCounter<span class="token operator">++</span><span class="token punctuation">,</span>
    callback<span class="token punctuation">,</span>
    priorityLevel<span class="token punctuation">,</span>
    startTime<span class="token punctuation">,</span>
    expirationTime<span class="token punctuation">,</span>
    sortIndex<span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>enableProfiling<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    newTask<span class="token punctuation">.</span>isQueued <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>startTime <span class="token operator">&gt;</span> currentTime<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 延迟任务</span>
    <span class="token comment">// This is a delayed task.</span>
    newTask<span class="token punctuation">.</span>sortIndex <span class="token operator">=</span> startTime<span class="token punctuation">;</span>
    <span class="token comment">// timerQueue是一个以startTime排序的最小堆，延迟任务用</span>
    <span class="token function">push</span><span class="token punctuation">(</span>timerQueue<span class="token punctuation">,</span> newTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// peek返回堆中的第一个node</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">peek</span><span class="token punctuation">(</span>taskQueue<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> newTask <span class="token operator">===</span> <span class="token function">peek</span><span class="token punctuation">(</span>timerQueue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// All tasks are delayed, and this is the task with the earliest delay.</span>
      <span class="token comment">// 如果所有任务都是延迟任务，并且新加的任务是延迟最短的</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>isHostTimeoutScheduled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Cancel an existing timeout.</span>
        <span class="token comment">// 若有新的延迟更短的任务，取消之前的</span>
        <span class="token function">cancelHostTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        isHostTimeoutScheduled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Schedule a timeout.</span>
      <span class="token comment">// 安排一个timeout</span>
      <span class="token function">requestHostTimeout</span><span class="token punctuation">(</span>handleTimeout<span class="token punctuation">,</span> startTime <span class="token operator">-</span> currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 非延迟任务，加入taskQueue，以expirationTime排序的min heap</span>
    newTask<span class="token punctuation">.</span>sortIndex <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>
    <span class="token function">push</span><span class="token punctuation">(</span>taskQueue<span class="token punctuation">,</span> newTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>enableProfiling<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">markTaskStart</span><span class="token punctuation">(</span>newTask<span class="token punctuation">,</span> currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
      newTask<span class="token punctuation">.</span>isQueued <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Schedule a host callback, if needed. If we're already performing work,</span>
    <span class="token comment">// wait until the next time we yield.</span>
    <span class="token comment">// 安排一个浏览器回调，如果已经有正在进行的更</span>
    <span class="token comment">// 新工作，则留到下一次变更控制权的时候再安排</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isHostCallbackScheduled <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isPerformingWork<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      isHostCallbackScheduled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token function">requestHostCallback</span><span class="token punctuation">(</span>flushWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// flushWork会被设为requestHostCallback中的scheduledHostCallback</span>
      <span class="token comment">// flushWork在Scheduler.js中</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> newTask<span class="token punctuation">;</span>
<span class="token punctuation">}</span>   
</code></pre></div><hr> <p><code>workLoop(hasTimeRemaining, initialTime) Scheduler.js</code></p> <ul><li><code>markTask***</code>起到标记作用，指明task在workloop中进行到哪一步了</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">workLoop</span><span class="token punctuation">(</span><span class="token parameter">hasTimeRemaining<span class="token punctuation">,</span> initialTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> currentTime <span class="token operator">=</span> initialTime<span class="token punctuation">;</span>
  <span class="token function">advanceTimers</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  currentTask <span class="token operator">=</span> <span class="token function">peek</span><span class="token punctuation">(</span>taskQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>
    currentTask <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
    <span class="token operator">!</span><span class="token punctuation">(</span>enableSchedulerDebugging <span class="token operator">&amp;&amp;</span> isSchedulerPaused<span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      currentTask<span class="token punctuation">.</span>expirationTime <span class="token operator">&gt;</span> currentTime <span class="token operator">&amp;&amp;</span>
      <span class="token punctuation">(</span><span class="token operator">!</span>hasTimeRemaining <span class="token operator">||</span> <span class="token function">shouldYieldToHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// This currentTask hasn't expired, and we've reached the deadline.</span>
      <span class="token comment">// 当前任务还没有到期但是分帧空闲时间已经没有了</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> callback <span class="token operator">=</span> currentTask<span class="token punctuation">.</span>callback<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      currentTask<span class="token punctuation">.</span>callback <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      currentPriorityLevel <span class="token operator">=</span> currentTask<span class="token punctuation">.</span>priorityLevel<span class="token punctuation">;</span>
      <span class="token keyword">const</span> didUserCallbackTimeout <span class="token operator">=</span> currentTask<span class="token punctuation">.</span>expirationTime <span class="token operator">&lt;=</span> currentTime<span class="token punctuation">;</span>
      <span class="token function">markTaskRun</span><span class="token punctuation">(</span>currentTask<span class="token punctuation">,</span> currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> continuationCallback <span class="token operator">=</span> <span class="token function">callback</span><span class="token punctuation">(</span>didUserCallbackTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">// callback为 </span>
      <span class="token comment">// performConcurrentWorkOnRoot(root, didTimeout)</span>
      <span class="token comment">// 如果已经过期</span>
      currentTime <span class="token operator">=</span> <span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> continuationCallback <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        currentTask<span class="token punctuation">.</span>callback <span class="token operator">=</span> continuationCallback<span class="token punctuation">;</span>
        <span class="token function">markTaskYield</span><span class="token punctuation">(</span>currentTask<span class="token punctuation">,</span> currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>enableProfiling<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">markTaskCompleted</span><span class="token punctuation">(</span>currentTask<span class="token punctuation">,</span> currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
          currentTask<span class="token punctuation">.</span>isQueued <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentTask <span class="token operator">===</span> <span class="token function">peek</span><span class="token punctuation">(</span>taskQueue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">pop</span><span class="token punctuation">(</span>taskQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token function">advanceTimers</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">pop</span><span class="token punctuation">(</span>taskQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    currentTask <span class="token operator">=</span> <span class="token function">peek</span><span class="token punctuation">(</span>taskQueue<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 抽取下一个任务</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// Return whether there's additional work</span>
  <span class="token comment">// 还有更多的任务，但是scheduler被暂停了</span>
  <span class="token comment">// 会再次postMessage触发performWorkUntilDeadline</span>
  <span class="token comment">// 留给接下来的scheduleHostCallback</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>currentTask <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> firstTimer <span class="token operator">=</span> <span class="token function">peek</span><span class="token punctuation">(</span>timerQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>firstTimer <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">requestHostTimeout</span><span class="token punctuation">(</span>handleTimeout<span class="token punctuation">,</span> firstTimer<span class="token punctuation">.</span>startTime <span class="token operator">-</span> currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/archived/react/tree-diffing.html">
        协调之Tree Diffing算法
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/archived/assets/js/app.8b58d644.js" defer></script><script src="/archived/assets/js/2.bf33e473.js" defer></script><script src="/archived/assets/js/42.c40fcb14.js" defer></script>
  </body>
</html>
